---
import BaseLayout from '../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';
import yaml from 'js-yaml';

export const prerender = true;

// Read posts from filesystem - supports both folder and single-file formats
const postsDir = path.join(process.cwd(), 'src/content/posts');
const entries = fs.existsSync(postsDir) ? fs.readdirSync(postsDir) : [];

const posts: Array<{slug: string; title: string; description?: string; publishedDate?: string; author?: string}> = [];

for (const entry of entries) {
  const fullPath = path.join(postsDir, entry);
  const stat = fs.statSync(fullPath);

  if (stat.isDirectory()) {
    // Folder-based post: slug/index.yaml
    const yamlPath = path.join(fullPath, 'index.yaml');
    if (fs.existsSync(yamlPath)) {
      const data = yaml.load(fs.readFileSync(yamlPath, 'utf-8')) as Record<string, any>;
      posts.push({ slug: entry, ...data });
    }
  } else if (entry.endsWith('.mdoc')) {
    // Single-file post: slug.mdoc with frontmatter
    const content = fs.readFileSync(fullPath, 'utf-8');
    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
    if (frontmatterMatch) {
      const data = yaml.load(frontmatterMatch[1]) as Record<string, any>;
      const slug = entry.replace('.mdoc', '');
      posts.push({ slug, ...data });
    }
  }
}

const sortedPosts = posts.sort((a, b) =>
  new Date(b.publishedDate || 0).getTime() - new Date(a.publishedDate || 0).getTime()
);

function formatDate(d: string | undefined) {
  return d ? new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
}
---
<BaseLayout title="Blog">
  <div class="container">
    <div class="page-header">
      <h1>Blog</h1>
      <p>Insights on Product, Tech, and AI</p>
    </div>

    <div class="search-box">
      <input type="text" class="search-input" placeholder="Search posts..." id="searchInput" />
    </div>

    <section class="posts-list" id="postsList">
      {sortedPosts.length === 0 ? (
        <div class="empty-state">
          <h2>No posts yet</h2>
          <p>Visit <a href="/keystatic">/keystatic</a> to create your first post.</p>
        </div>
      ) : (
        sortedPosts.map((post) => (
          <a href={`/posts/${post.slug}`} class="post-card" data-title={post.title.toLowerCase()} data-desc={(post.description || '').toLowerCase()}>
            <h2 class="post-card-title">{post.title}</h2>
            <div class="post-card-meta">
              <span>{post.author || 'NorthAI Team'}</span>
              <span>{formatDate(post.publishedDate)}</span>
            </div>
            {post.description && <p class="post-card-description">{post.description}</p>}
          </a>
        ))
      )}
    </section>
  </div>

  <script is:inline>
    document.getElementById('searchInput')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.post-card').forEach(card => {
        const title = card.dataset.title || '';
        const desc = card.dataset.desc || '';
        const match = title.includes(query) || desc.includes(query);
        card.style.display = match ? 'block' : 'none';
      });
    });
  </script>
</BaseLayout>
