---
import BaseLayout from '../layouts/BaseLayout.astro';
import { createReader } from '@keystatic/core/reader';
import keystaticConfig from '../../keystatic.config';

const reader = createReader(process.cwd(), keystaticConfig);
const posts = await reader.collections.posts.all();
const sortedPosts = posts.sort((a, b) => new Date(b.entry.publishedDate || 0).getTime() - new Date(a.entry.publishedDate || 0).getTime());

function formatDate(d: string | null) {
  return d ? new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
}
---
<BaseLayout title="Blog">
  <div class="container">
    <section class="posts-list">
      {sortedPosts.length === 0 ? (
        <div style="text-align:center;padding:60px 20px;">
          <h2>No posts yet</h2>
          <p style="color:#757575;">Visit <a href="/keystatic">/keystatic</a> to create your first post.</p>
        </div>
      ) : (
        sortedPosts.map((post) => (
          <article class="post-card">
            <h2 class="post-card-title"><a href={`/posts/${post.slug}`}>{post.entry.title}</a></h2>
            <div class="post-card-meta">
              <span>{post.entry.author}</span>
              <span>{formatDate(post.entry.publishedDate)}</span>
            </div>
            {post.entry.description && <p class="post-card-description">{post.entry.description}</p>}
          </article>
        ))
      )}
    </section>
  </div>
</BaseLayout>
